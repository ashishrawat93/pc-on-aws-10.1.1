{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "AWS Cloud Formation Template for deployment of Informatica Powercenter Version 10.1.1 on a VPC infrastructure. This template lets you add a new node to and existing RHEL Informatica Deployment. **WARNING** This template creates Amazon EC2 instance and related resources. You will be billed for the AWS resources used if you create a stack from this template.",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Network Configuration"
                    },
                    "Parameters": [
                        "PublicSubnet1ID",
                        "SecurityGroup"
                    ]
                },
                {
                    "Label": {
                        "default": "Amazon EC2 Configuration"
                    },
                    "Parameters": [
                        "KeyPairName",
                        "PowerCenterInstanceType",
                        "EnableEIP"
                    ]
                },
                {
                    "Label": {
                        "default": "Amazon RDS Configuration"
                    },
                    "Parameters": [
                        "RDSDatabaseNameServiceName",
                        "RDSEndpointAddress",
                        "RDSEndpointPort",
                        "DatabaseUsername",
                        "DatabasePassword",
                        "DatabasePasswordConfirm"
                    ]
                },
                {
                    "Label": {
                        "default": "Informatica PowerCenter Configuration"
                    },
                    "Parameters": [
                        "InformaticaDomainName",
                        "InformaticaDomainUsername",
                        "InformaticaDomainPassword",
                        "InformaticaDomainPasswordConfirm",
                        "InformaticaMasterNodeName",
                        "MasterNodePrivateIP",
                        "InformaticaNodeName",
                        "EncryptionKeyPhrase"
                    ]
                }
            ],
            "ParameterLabels": {
                "PublicSubnet1ID": {
                    "default": "Public Subnet ID"
                },
                "SecurityGroup": {
                    "default": "Security Group"
                },
                "KeyPairName": {
                    "default": "Key Pair Name"
                },
                "PowerCenterInstanceType": {
                    "default": "New Node Instance Type"
                },
                "EnableEIP": {
                    "default": "Enable Elastic IP Addressing"
                },
                "RDSDatabaseNameServiceName": {
                    "default": "RDS Database Service Name"
                },
                "RDSEndpointAddress": {
                    "default": "RDS Endpoint Address"
                },
                "DatabaseUsername": {
                    "default": "Database Username"
                },
                "DatabasePassword": {
                    "default": "Database Password"
                },
                "DatabasePasswordConfirm": {
                    "default": "Confirm Password"
                },
                "InformaticaDomainName": {
                    "default": "Informatica Domain Name"
                },
                "InformaticaDomainUsername": {
                    "default": "Informatica Administrator Username"
                },
                "InformaticaDomainPassword": {
                    "default": "Informatica Administrator Password"
                },
                "InformaticaDomainPasswordConfirm": {
                    "default": "Confirm Password"
                },
                "InformaticaMasterNodeName": {
                    "default": "Informatica Master Node Name"
                },
                "MasterNodePrivateIP": {
                    "default": "Master Node Private IP Address"
                },
                "InformaticaNodeName": {
                    "default": "New Node Name"
                },
                "EncryptionKeyPhrase": {
                    "default": "Encryption Key Phrase"
                },
                "RDSEndpointPort": {
                    "default": "RDS Database Port"
                }
            }
        }
    },
    "Parameters": {
        "RDSDatabaseNameServiceName": {
            "AllowedPattern": "^([a-zA-Z][a-z0-9A-Z_]{4,8})$",
            "ConstraintDescription": "Only alphanumeric characters and underscore are allowed. Should begin with an alphabet. The value must be 4-8",
            "Description": "Database Name for RDS Instance on which the Informatica Domain is deployed",
            "Type": "String",
            "Default": "InfaDB",
            "MinLength": "4",
            "MaxLength": "8"
        },
        "RDSEndpointAddress": {
            "Type": "String",
            "Description": "RDS Engpoint Address of the Informatica Domain Database",
            "MinLength": "4",
            "MaxLength": "82"
        },
        "RDSEndpointPort": {
            "Type": "String",
            "Description": "RDS Database Port of the Informatica Domain Database",
            "Default": "1521",
            "MinLength": "3",
            "MaxLength": "6"
        },
        "DatabasePassword": {
            "AllowedPattern": "^([a-zA-Z][a-z0-9A-Z_]{3,20})$",
            "ConstraintDescription": "Only alphanumeric characters and underscore are allowed. Should begin with an alphabet. The value must be 8-18",
            "Description": "Password of the Amazon RDS database account. Only alphanumeric characters and underscore are allowed. Should begin with an alphabet. The value must be 8-18",
            "MaxLength": "18",
            "MinLength": "8",
            "NoEcho": "True",
            "Type": "String"
        },
        "DatabasePasswordConfirm": {
            "AllowedPattern": "^([a-zA-Z][a-z0-9A-Z_]{3,20})$",
            "ConstraintDescription": "Only alphanumeric characters and underscore are allowed. Should begin with an alphabet. The value must be 8-18",
            "Description": "Password of the Amazon RDS database account.",
            "MaxLength": "18",
            "MinLength": "8",
            "NoEcho": "True",
            "Type": "String"
        },
        "MasterNodePrivateIP": {
            "Type": "String",
            "Description": "Private Ip address of the Informatica Master Node",
            "MinLength": "4",
            "MaxLength": "42"
        },
        "DatabaseUsername": {
            "AllowedPattern": "^([a-zA-Z][a-z0-9A-Z_]{3,20})$",
            "ConstraintDescription": "Only alphanumeric characters and underscore are allowed. Should begin with an alphabet. The value must be 4-20",
            "Description": "Username of the Amazon RDS database account",
            "MaxLength": "30",
            "MinLength": "4",
            "Type": "String"
        },
        "EncryptionKeyPhrase": {
            "AllowedPattern": "^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=\\S+$).{8,}$",
            "ConstraintDescription": "It should be 8 to 20 characters long, at least one uppercase letter at least one lowercase letter-at least one number Does not contain spaces",
            "Description": "The text string used as the base word from which to generate an encryption key for the Informatica domain",
            "MaxLength": "32",
            "MinLength": "8",
            "NoEcho": "true",
            "Type": "String"
        },
        "InformaticaMasterNodeName": {
            "AllowedPattern": "^([a-zA-Z][a-z0-9A-Z_]{3,20})$",
            "ConstraintDescription": "Only alphanumeric characters and underscore are allowed. Should begin with an alphabet. The value must be 4-20",
            "Description": "Name of the Informatica Master Node",
            "Type": "String",
            "Default": "Infa",
            "MinLength": "2",
            "MaxLength": "20"
        },
        "InformaticaNodeName": {
            "AllowedPattern": "^([a-zA-Z][a-z0-9A-Z_]{3,20})$",
            "ConstraintDescription": "Only alphanumeric characters and underscore are allowed. Should begin with an alphabet. The value must be 4-20",
            "Description": "Node Name of the new Node that will get added to the Informatica Domain",
            "Type": "String",
            "Default": "Infa",
            "MinLength": "2",
            "MaxLength": "20"
        },
        "InformaticaDomainName": {
            "AllowedPattern": "^([a-zA-Z][a-z0-9A-Z_]{7,20})$",
            "ConstraintDescription": "Only alphanumeric characters and underscore are allowed. Should begin with an alphabet. The value must be 4-20",
            "Description": "Name of the Informatica Domain.",
            "Type": "String",
            "Default": "InfaDomain",
            "MinLength": "8",
            "MaxLength": "20"
        },
        "InformaticaDomainUsername": {
            "AllowedPattern": "^([a-zA-Z][a-z0-9A-Z_]{7,20})$",
            "ConstraintDescription": "Only alphanumeric characters and underscore are allowed. Should begin with an alphabet. The value must be 4-20",
            "Description": "Username of the Informatica Domain.",
            "MaxLength": "32",
            "MinLength": "8",
            "Type": "String"
        },
        "InformaticaDomainPassword": {
            "AllowedPattern": "^(?=.*[A-Z])(?=.*[a-z])(?=.*\\d)(?=.*[^\\s\\w])(?!.*[\"$&]).{7,32}$",
            "ConstraintDescription": "Password must be at least 8 characters in length. Should contain at least one special character, number, upper-case and lower-case character. Double quote(\"),ampersand(&) and dollar($) is not allowed",
            "Description": "Password of the Informatica Domain. Password must be at least 8 characters in length. Should contain at least one special character, number, upper-case and lower-case character. Double quote(\"),ampersand(&) and dollar($) is not allowed",
            "NoEcho": "True",
            "MaxLength": "32",
            "MinLength": "8",
            "Type": "String"
        },
        "InformaticaDomainPasswordConfirm": {
            "AllowedPattern": "^(?=.*[A-Z])(?=.*[a-z])(?=.*\\d)(?=.*[^\\s\\w])(?!.*[\"$&]).{7,32}$",
            "ConstraintDescription": "Password must be at least 8 characters in length. Should contain at least one special character, number, upper-case and lower-case character. Double quote(\"),ampersand(&)s and dollar($) is not allowed",
            "Description": "Password of the Informatica Domain.",
            "NoEcho": "True",
            "MaxLength": "32",
            "MinLength": "8",
            "Type": "String"
        },
        "PowerCenterInstanceType": {
            "AllowedValues": [
                "c4.xlarge",
                "c4.2xlarge",
                "c4.4xlarge",
                "c4.8xlarge",
                "r3.large",
                "r3.xlarge",
                "r3.2xlarge",
                "r3.4xlarge",
                "r3.8xlarge"
            ],
            "Default": "c4.2xlarge",
            "Description": "Instance Type for Informatica Domain. Default is c4.2xlarge",
            "Type": "String"
        },
        "KeyPairName": {
            "Description": "Name of an existing EC2 KeyPair to enable external access to the Informatica Domain",
            "Type": "AWS::EC2::KeyPair::KeyName",
            "MaxLength": "32",
            "MinLength": "1"
        },
        "PublicSubnet1ID": {
            "Description": "Select a publicly accessible subnet ID for the new Informatica Node which is same as the Subnet for Informatica Master Node",
            "Type": "AWS::EC2::Subnet::Id",
            "MinLength": "1"
        },
        "EnableEIP": {
            "Description": "Assign Elastic IPs to Instances. Default value is Yes",
            "Type": "String",
            "AllowedValues": [
                "Yes",
                "No"
            ],
            "Default": "Yes"
        },
        "SecurityGroup": {
            "Description": "Select a Secuity group which belongs to  the Public Subnet above",
            "Type": "AWS::EC2::SecurityGroup::Id",
            "MinLength": "1"
        }
    },
    "Rules": {
        
        "InformaticaPasswordConfirm": {
            "Assertions": [
                {
                    "Assert": {
                        "Fn::Equals": [
                            {
                                "Ref": "InformaticaDomainPassword"
                            },
                            {
                                "Ref": "InformaticaDomainPasswordConfirm"
                            }
                        ]
                    },
                    "AssertDescription": "Informatica Domain Passwords do not match"
                }
            ]
        },
        "DatabasePasswordConfirm": {
            "Assertions": [
                {
                    "Assert": {
                        "Fn::Equals": [
                            {
                                "Ref": "DatabasePassword"
                            },
                            {
                                "Ref": "DatabasePasswordConfirm"
                            }
                        ]
                    },
                    "AssertDescription": "Database Passwords do not match"
                }
            ]
        }
    },
    "Mappings": {
        "AWSAMIRegionMap": {
            "AMI": {
                "INFORMATICAPCRHELHVM": "Informatica-PowerCenter-10.1.1-RHEL7"
            },
            "ap-northeast-1": {
                "INFORMATICAPCRHELHVM": "TBD"
            },
            "ap-northeast-2": {
                "INFORMATICAPCRHELHVM": "TBD"
            },
            "ap-south-1": {
                "INFORMATICAPCRHELHVM": "TBD"
            },
            "ap-southeast-1": {
                "INFORMATICAPCRHELHVM": "TBD"
            },
            "ap-southeast-2": {
                "INFORMATICAPCRHELHVM": "TBD"
            },
            "eu-central-1": {
                "INFORMATICAPCRHELHVM": "TBD"
            },
            "eu-west-1": {
                "INFORMATICAPCRHELHVM": "TBD"
            },
            "sa-east-1": {
                "INFORMATICAPCRHELHVM": "TBD"
            },
            "us-east-1": {
                "INFORMATICAPCRHELHVM": "ami-8c5fab9a"
            },
            "us-east-2": {
                "INFORMATICAPCRHELHVM": "TBD"
            },
            "us-west-1": {
                "INFORMATICAPCRHELHVM": "TBD"
            },
            "us-west-2": {
                "INFORMATICAPCRHELHVM": "TBD"
            }
        },
        "Config": {
            "Settings": {
                "IntegrationServiceName": "PowerCenterIntegrationService",
                "RepositoryServiceName": "PowerCenterRepository",
                "GridName": "InfaDefaultGrid",
                "DatabaseType": "Oracle",
                "EFSDirectory": "/home/ec2-user/Informatica/10.1.1/infa_shared",
                "LicenseFile": "/home/ec2-user/Informatica/10.1.1/License.key"
            }
        }
    },
    "Conditions": {
        "EnableEIPCondition": {
            "Fn::Equals": [
                {
                    "Ref": "EnableEIP"
                },
                "Yes"
            ]
        }
    },
    "Resources": {
        "InfaElasticIPAddress": {
            "Condition": "EnableEIPCondition",
            "Type": "AWS::EC2::EIP",
            "Properties": {
                "Domain": "vpc",
                "InstanceId": {
                    "Ref": "InfaNode"
                }
            }
        },
        "InfaNode": {
            "Type": "AWS::EC2::Instance",
            "Metadata": {
                "AWS::CloudFormation::Init": {
                    "config": {
                        "commands": {
                            "1-setup": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "sh /home/ec2-user/InfaEc2Scripts/linInfaInstallerEc2.sh ",
                                            {
                                                "Ref": "InformaticaDomainPassword"
                                            },
                                            " ",
                                            {
                                                "Ref": "DatabasePassword"
                                            },
                                            " null ",
                                            {
                                                "Ref": "EncryptionKeyPhrase"
                                            }
                                        ]
                                    ]
                                }
                            }
                        }
                    }
                }
            },
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Ref": "InformaticaNodeName"
                        }
                    }
                ],
                "ImageId": {
                    "Fn::FindInMap": [
                        "AWSAMIRegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        "INFORMATICAPCRHELHVM"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1ID"
                },
                "SecurityGroupIds": [
                    {
                        "Ref": "SecurityGroup"
                    }
                ],
                "InstanceType": {
                    "Ref": "PowerCenterInstanceType"
                },
                "KeyName": {
                    "Ref": "KeyPairName"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash \n",
                                "echo \"Initializing variables\" \n",
                                "export SINGLE_NODE=0 \n",
                                "export CREATE_DOMAIN=0 \n",
                                "export JOIN_DOMAIN=1 \n",
                                "export SERVES_AS_GATEWAY=1",
                                "\n",
                                "export DOMAIN_USER_NAME=\"",
                                {
                                    "Ref": "InformaticaDomainUsername"
                                },
                                "\"\n",
                                "export AWS_REGION=\"",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\"\n",
                                "export DB_TYPE=\"",
                                {
                                    "Fn::FindInMap": [
                                        "Config",
                                        "Settings",
                                        "DatabaseType"
                                    ]
                                },
                                "\"\n",
                                "export DB_ADDRESS=\"",
                                {
                                    "Ref": "RDSEndpointAddress"
                                },
                                "\"\n",
                                "export DB_PORT=\"",
                                {
                                    "Ref": "RDSEndpointPort"
                                },
                                "\"\n",
                                "export DB_UNAME=\"",
                                {
                                    "Ref": "DatabaseUsername"
                                },
                                "\"\n",
                                "export DB_SERVICENAME=\"",
                                {
                                    "Ref": "RDSDatabaseNameServiceName"
                                },
                                "\"\n",
                                "export DOMAIN_NAME=\"",
                                {
                                    "Ref": "InformaticaDomainName"
                                },
                                "\"\n",
                                "export NODE_NAME=\"",
                                {
                                    "Ref": "InformaticaMasterNodeName"
                                },
                                "\"\n",
                                "export GRID_NAME=\"",
                                {
                                    "Fn::FindInMap": [
                                        "Config",
                                        "Settings",
                                        "GridName"
                                    ]
                                },
                                "\"\n",
                                "export JOIN_NODE_NAME=\"",
                                {
                                    "Ref": "InformaticaNodeName"
                                },
                                "\"\n",
                                "export INTEGRATION_SERVICE_NAME=\"",
                                {
                                    "Fn::FindInMap": [
                                        "Config",
                                        "Settings",
                                        "IntegrationServiceName"
                                    ]
                                },
                                "\"\n",
                                "export DOMAIN_HOST_NAME=\"",
                                {
                                    "Ref": "MasterNodePrivateIP"
                                },
                                "\"\n",
                                "mkdir /home/ec2-user/Informatica/10.1.1/infa_shared",
                                "\n",
                                "chmod -R 777 /home/ec2-user/Informatica/10.1.1/infa_shared",
                                "\n",
                                "echo \"running cfn init\" \n",
                                "/opt/aws/bin/cfn-init --stack ",
                                {
                                    "Ref": "AWS::StackId"
                                },
                                " --resource InfaNode ",
                                " --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "echo \"running cfn signal\" \n",
                                "/opt/aws/bin/cfn-signal -e $? ",
                                " --stack ",
                                {
                                    "Ref": "AWS::StackId"
                                },
                                " --resource InfaNode ",
                                " --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n"
                            ]
                        ]
                    }
                }
            },
            "CreationPolicy": {
                "ResourceSignal": {
                    "Timeout": "PT1H"
                }
            }
        }
    },
    "Outputs": {
        "PowerCenterAgentIP": {
            "Value": {
                "Fn::GetAtt": [
                    "InfaNode",
                    "PublicIp"
                ]
            },
            "Description": "Elastic IP address of the PowerCenter instance"
        },
        "InstanceID": {
            "Description": "Instance ID of the newly created EC2 Master instance",
            "Value": {
                "Ref": "InfaNode"
            }
        },
        "AvailabilityZone": {
            "Description": "Availability Zone of the newly created EC2 instances",
            "Value": {
                "Fn::GetAtt": [
                    "InfaNode",
                    "AvailabilityZone"
                ]
            }
        },
        "PublicDNS": {
            "Description": "Public DNS name of the newly created EC2 Master instance",
            "Value": {
                "Fn::GetAtt": [
                    "InfaNode",
                    "PublicDnsName"
                ]
            }
        }
    }
}